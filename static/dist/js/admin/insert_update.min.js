define(["jquery-nos","jquery-ui.sortable","jquery-ui.resizable"],function(a){"use strict";return function(b,c,d,e){function f(){var b="";return V.find("tr.preview_row").each(function(c){var d=a(this).find("td.preview");d.length>0&&""!=b&&(b+="\n"),d.each(function(c){var d=a(this),e=q(d);if(e){c>0&&(b+=",");var f=d.is(".page_break")?"page_break":m(e);b+=f+"="+K(d)}})}),b}function g(){return V.find("tr.preview_row.page_break").length}function h(b){var c=(ba.data("params")||{}).where||"bottom",d=V.closest(".nos-fixed-content").get(0),e=d.scrollTop;a.ajax({url:"admin/noviusos_form/form/render_layout/"+b,dataType:"json",success:function(b){if(ba.hide(),b.fields&&b.layout){var f=a(b.fields.join(""));"top"==c&&(f=a(f.get().reverse())),X.append(f),f=f.not("script"),f.nosFormUI();var g=a();f.each(function(d){var e=a(this);l(e,c),b.previews&&b.previews[d]?y(e,b.previews[d]):E(e),C(e),g=g.add(o(e))}),Q(b.layout),d.scrollTop=e,g.addClass("ui-state-hover"),setTimeout(function(){g.removeClass("ui-state-hover")},500)}}})}function i(a){if(a=a||W.find(".preview.ui-state-active"),0==a.length&&(a=Z.not(":not(.ui-state-active)")),a.length>0){var b=a.is(".submit_informations")?14:-40,c=a.position();X.css({paddingTop:Math.max(0,c.top+b)+"px"})}}function j(a){var b=X.find(".show_hide").show();a&&a.is(".page_break")?b.addClass("page_break"):b.removeClass("page_break")}function k(){X.find(".show_hide").hide().removeClass("page_break")}function l(a,b){var c=s(a,"field_driver");if(0!=c.length&&c.val()){var d=m(a);d&&n(d,b),a.hide()}}function m(a){return a.data("field-id")||s(a,"field_id").val()}function n(a,b){var c=aa.clone(),d=c.find("td.preview");switch(J(d,4),d.data("field-id",a),d.attr("data-field-id",a),d.find("button.notransform").removeClass("notransform"),d.nosFormUI().show().nosOnShow(),b){case"top":W.prepend(d.parent());break;case"bottom":default:W.append(d.parent())}return d}function o(a){var b=m(a);return p(b)}function p(a){var b=W.find('.preview[data-field-id="'+a+'"]');return!!b.length&&b}function q(a){var b=a.data("field-id"),c=X.find('.field_enclosure[data-field-id="'+b+'"]');return!!c.length&&c}function r(a){for(var b=a.find(":input").serializeArray(),c=0;c<b.length;c++)b[c].name=b[c].name.replace(/field\[[0-9]*\]\[([^\]]+)\]/,"$1");return b}function s(a,b){return a.find('[name$="['+b+']"]')}function t(a){j(a),a.is(".field_enclosure")&&(a.show(),a.nosOnShow()),a.siblings(".field_enclosure").hide(),i();var b=s(a,"field_submit_label");0==b.length&&Z.removeClass("ui-state-active")}function u(a){k(),a&&a.hide()}function v(a){var b=o(a);a.remove(),k(),b&&b.addClass("ui-state-error").hide(500,function(){b.remove(),P()})}function w(a){a.addClass("frozen"),o(a).addClass("frozen")}function x(a){a.removeClass("frozen"),o(a).removeClass("frozen")}function y(b,c){var d=o(b),e=s(b,"field_details").val();e&&e.length>0&&(c+='<div class="details">'+a("<div/>").text(e).html()+"</div>"),d.find("div.preview_content").html(c),d.find("input, select").attr("readonly",!0).on("click",function(a){var c=z();c&&c.data("field-id")!==b.data("field-id")||(a.preventDefault(),a.stopPropagation())}),F(d.closest("tr"))}function z(){var a=W.find(".preview.ui-state-active");return q(a)}function A(){var a=W.find(".ui-widget-content.ui-state-active");a.length>0&&(a.removeClass("ui-state-active"),u(q(a)))}function B(a){var b=o(a);b&&(W.find("td.preview.ui-state-active").removeClass("ui-state-active"),b.addClass("ui-state-active"))}function C(a){var b=o(a);if(b){var c=b.find("label.preview_label"),d=s(a,"field_driver").val();H("field_label",d)?(c.text(D(a)),c.show()):c.hide()}}function D(a){var b=s(a,"field_label").val();return s(a,"field_mandatory").is(":checked")&&(b+="*"),b}function E(b){var c=m(b),d=r(b);_.request(function(e){a.ajax({url:"admin/noviusos_form/form/render_field_preview/"+c,type:"POST",dataType:"json",data:{fieldData:JSON.stringify(d)}}).done(function(a){"undefined"!=typeof a.preview&&y(b,a.preview)}).always(function(){e()})})}function F(b){(b||W.find("tr")).css("height","").each(function(){var b=a(this).find("div.resizable").css("height","");b.css("height",a(this).height())})}function G(a,b,d){var e=c.driversConfig[a]||{};return b?R(e.config,b,d):e.config}function H(b,c){var d=G(c);if(d){var e=R(d,"admin.layout");if("object"==typeof e)for(var f in e)if(e.hasOwnProperty(f)&&"object"==typeof e[f].fields&&a.inArray(b,e[f].fields)!==-1)return!0}return!1}function I(b,c){if(0!=b.find("td:not(.padding)").length){b.find("td.padding").remove();var d=b.find("td.preview:visible"),e=[],f=0,g=[],h=5-d.length;if(d.each(function(){var b=a(this),c=b.find(".resizable");0==c.length&&(c=b);var d=Math.round(c.outerWidth()/ca);d=Math.max(1,Math.min(h,d)),d=parseInt(c.attr("colspan"))||d,e.push(d),f+=d,b.data("colspan",d),(0==g.length||d>g.data("colspan"))&&(g=b)}),f>4){void 0!==c&&null!=c||(c=g.get(0));var i=f-4,j=d.filter(function(){return a(this).data("colspan")>1&&this!=c});j.closest("td.preview").each(function(){for(var b=a(this),c=b.data("colspan"),d=1;c-d>1&&i-d>0;)d++;i-=d,b.data("colspan",c-d)}),i>0&&a(c).data("colspan",a(c).data("colspan")-i)}if(b.find("td.preview").each(function(){J(a(this),a(this).data("colspan")),a(this).removeData("colspan")}),f<4){var k=a('<td class="padding">&nbsp;</td>');J(k,4-f),b.append(k)}}}function J(a,b){a.attr("colspan",b).children().css("width","auto")}function K(a){return Math.round(a.width()/ca)}function L(b){b.find("td.preview:visible").each(function(){var b=a(this);b.data("saved_colspan",K(b))})}function M(b){b.find("td.preview:visible").each(function(){var b=a(this),c=b.data("saved_colspan");c&&J(b,c)})}function N(){try{U.destroy()}catch(a){}W.find("td.padding").remove(),W.find("td.sortable_placeholder").remove(),W.find("tr").addClass("preview_row").filter(function(){return 0==a(this).children().not(".placeholder").length}).remove(),W.find("td.page_break").each(function(){var b=a(this);J(b,4),b.closest("tr").addClass("page_break")}),W.find("tr").before('<tr class="preview_row preview_inserter"><td class="padding" colspan="4">&nbsp;</td></tr>'),W.append('<tr class="preview_row preview_inserter"><td class="padding" colspan="4">&nbsp;</td></tr>'),W.find("tr.preview_row").each(function(){I(a(this))}),W.find("tr").removeClass("preview_row_sortable").filter(function(){return a(this).children().not(".padding").length<4}).addClass("preview_row_sortable");var c;U=W.find("tr.preview_row:not(.page_break)").sortable({connectWith:b+" tr.preview_row_sortable:not(.page_break)",dropOnEmpty:!0,helper:"clone",appendTo:b,items:"> td.preview",forceHelperSize:!0,placeholder:"sortable_placeholder preview",tolerance:"pointer",handle:".handle",beforeStop:function(a,b){},start:function(a,b){var c=b.placeholder.closest("tr");A(),c.css("height",b.item.height()),b.placeholder.addClass("ui-widget-content ui-state-active"),b.placeholder.children().css("height",c.css("height")),J(b.placeholder,K(b.helper))},update:function(a,b){var d=b.item.closest("tr");d.css("height",""),d.children().css("height",d.css("height")),J(b.item,c),I(d,b.item.get(0)),P()},over:function(a,b){var d=b.placeholder.closest("tr");b.item.children().css("height",""),b.placeholder.hide(),L(d),b.placeholder.show(),b.placeholder.children().css("height",d.css("height")),J(b.placeholder,K(b.helper)),I(d,b.placeholder.get(0)),c=K(b.placeholder)},out:function(a,b){var c=b.placeholder.closest("tr");M(c)}}),W.find("tr.preview_row.page_break").sortable({appendTo:b,connectWith:b+" tr.preview_row_sortable.preview_inserter",helper:"clone",dropOnEmpty:!0,forceHelperSize:!0,forcePlaceholderSize:!0,placeholder:"sortable_placeholder preview",handle:".handle",start:function(a,b){var c=b.placeholder.closest("tr");A(),c.css("height",b.item.height()),b.placeholder.addClass("ui-widget-content ui-state-active"),b.placeholder.children().css("height",c.css("height")),J(b.placeholder,4)}})}function O(){try{T.destroy()}catch(a){}T=W.find("td.preview").not(".page_break").find("div.resizable"),T=T.resizable({ghost:!0,handles:"se",autoHideType:!0,helper:"helper_resize preview ui-state-active",grid:[ca,"2000"],start:function(a,b){A()},stop:function(a,b){var c=b.element.closest("tr");I(c,b.element.closest("td").get(0)),F(c)}})}function P(a){O(),N(),F(a)}function Q(b){a.each(b.split("\n"),function(){var b=null;""!=this&&a.each(this.split(","),function(){var a=this.split("="),c=a[0],d=a[1],e=p(c);e&&(J(e,d),b&&b.after(e),b=e)})}),P()}function R(a,b,c){var d=b.split(".").reduce(function(a,b){return a?a[b]:void 0},a||self);return"undefined"!=typeof d?d:c}function S(a){var b,c,d;"number"!=typeof a&&(a=1e3);var e=function(e){b=!0;var f=function(){b=!1,d=+new Date,c&&(c(),c=null)};if(d){var g=+new Date-d;if(g<a)return void setTimeout(function(){e(f)},a-g)}e(f)};this.request=function(a){b?c=function(){e(a)}:e(a)}}var T,U,V=a(b),W=V.find(".preview_container"),X=V.find(".fields_container"),Y=V.closest("form").find("[name=form_layout]"),Z=V.find(".submit_informations"),$=a('.nos-ostabs-panel.ui-widget-content:not(".nos-ostabs-hide")'),_=new S(800);X.show(),Z.show();var aa=V.find("[data-id=clone_preview]").clone().removeAttr("data-id");V.find("[data-id=clone_preview]").remove();var ba=V.find(".field_blank_slate");ba.find("label").hover(function(){a(this).addClass("ui-state-hover")},function(){a(this).removeClass("ui-state-hover")});var ca=Math.round(W.outerWidth()/4);W.width(W.outerWidth()-W.width()),a(document).ready(function(){$.find('button.ui-priority-primary[type="submit"]').unbind().bind("click",function(){V.closest("form").submit()})}),V.closest("form").submit(function(b){var c=f();console.log("layout",c),Y.val(c);var d={form_layout:c},e={},g="field[",h=/[^\[]+\[([0-9]+)\]\[([^\]]+)\]/;a(this).find(":input").each(function(){var b=a(this);if(b.attr("name")){if(0!=b.attr("name").indexOf(g))return void((b.not('[type="checkbox"]').length||b.is(":checked"))&&(d[b.attr("name")]=b.val()));var c=b.attr("name").match(h);if(c.length&&!(c.length<3)){var f=parseInt(c[1]),i=c[2],j=b.val();b.is(":checkbox")&&(j=+b.is(":checked")),f&&i&&(e[f]||(e[f]={}),e[f][i]=j)}}}),d._csrf=a(this).find('input[name="_csrf"]:first').val(),d.fields=JSON.stringify(e);var i=a(this).attr("action");return V.nosAjax({data:d,type:"post",url:i,dataType:"json"}),!1}),V.on("click","[data-id=add]",function(b){b.preventDefault(),b.stopPropagation();var c=a(this).data("params");ba.data("params",c);var d=g();if("page_break"==c.type){var e="page-break-"+(d+1),f=a("<div />").addClass("field_enclosure page_break").attr("data-field-id",e).data("field-id",e);X.append(f),f.nosFormUI();var h=n(e,c.where||"bottom");h.addClass("page_break ui-widget-header"),Q("page_break=4")}else a(this).closest(".button-container")["top"===c.where?"append":"prepend"](ba),ba.show(),i()}),a("html, body").on("click",function(){ba.hide()}),ba.on("click",function(a){a.stopPropagation()}),ba.on("click","label",function(b){b.preventDefault(),h(a(this).data("layout-name"))}),W.on("click","td.preview",function(b){b.preventDefault();var c=a(this),d=q(c);d&&(B(d),t(d),s(d,"field_label").focus())}),W.on("click","[data-id=copy]",function(a){a.preventDefault(),a.stopPropagation()}),X.on("click","[data-id=delete]",function(b){if(b.preventDefault(),b.stopPropagation(),confirm(a.nosCleanupTranslation(c.textDelete))){var d=z();d&&v(d)}}),X.on("change",'select[name$="[field_driver]"]',function(b){var c=a(this).closest(".field_enclosure"),d=m(c),e=r(c);w(c),a.ajax({url:"admin/noviusos_form/form/render_field/"+d,type:"POST",dataType:"json",data:{fieldData:JSON.stringify(e)}}).done(function(b){if(b.meta){var d=a(b.meta);c.replaceWith(d),c=d,c.nosFormUI()}C(c),"undefined"!=typeof b.preview?y(c,b.preview):E(c),c.find(".wijmo-wijaccordion-content").each(function(){var b=a(this);0==b.find(":input").filter(function(){return"none"!=a(this).closest("p").css("display")}).length?b.prev().hide():b.prev().show()}),c.find('[name$="[field_label]"]').trigger("change"),c.find('[name$="[field_style]"]').trigger("change")}).always(function(){console.log("unfreeze"),x(c)})}),X.on("change",'select[name$="[field_style]"]',function(b){var c=a(this).val(),d=a(this).closest(".field_enclosure"),e=d.find('[name$="[field_message]"]'),f=a("p"==c?'<textarea rows="4"></textarea>':'<input type="text" />');f.attr({name:e.attr("name"),id:e.attr("id")}),f.val(e.val()),f.insertAfter(e),e.remove(),f.parent().nosFormUI(),f.trigger("change")}),X.on("change keyup",'input[name$="[field_label]"]',function(){C(a(this).closest(".field_enclosure"))}),X.on("change",'input[name$="[field_mandatory]"]',function(){C(a(this).closest(".field_enclosure"))}),X.on("change keyup",'textarea[name$="[field_choices]"],[name$="[field_message]"],[name$="[field_default_value]"],input[name$="[field_width]"],input[name$="[field_height]"],textarea[name$="[field_details]"]',function(){E(a(this).closest(".field_enclosure"))}),X.on("refreshPreview",".field_enclosure",function(){var b=a(this);E(b),C(b)}),X.children(".field_enclosure").hide(),k(),Q(Y.val()),setTimeout(function(){F()},100),X.children(".field_enclosure").each(function(){C(a(this))}),d&&h("default");var da=V.find("[name=form_captcha]"),ea=V.find("[name=form_submit_label]"),fa=V.find("[name=form_submit_email]");da.on("change",function(){Z.find(".form_captcha")[a(this).is(":checked")?"show":"hide"]()}).trigger("change"),ea.on("change keyup",function(){Z.find("input:last").val(a(this).val())}).trigger("change"),fa.on("change keyup",function(){var b=a.trim(a(this).val());Z.find(".form_submit_email").find("span:first").html(b.replace("\n",", ","g")).end().find("span:last")[b?"hide":"show"]()}).trigger("change"),Z.on("click",function(){var a=ea.closest(".accordion");A(),t(a),u(),i(Z),Z.addClass("ui-state-active"),V.find(".preview_arrow").show()})}});
//# sourceMappingURL=insert_update.min.js.map