define(["jquery-nos","jquery-ui.sortable","jquery-ui.resizable"],function($){"use strict";return function(id,options,is_new,is_expert){var $container=$(id);var $resizable;var $sortable;var $preview_container=$container.find(".preview_container");var $fields_container=$container.find(".fields_container");var $layout=$container.closest("form").find("[name=form_layout]");var $submit_informations=$container.find(".submit_informations");var $currentTab=$('.nos-ostabs-panel.ui-widget-content:not(".nos-ostabs-hide")');var throttle=new ThrottleRequest(800);$fields_container.show();$submit_informations.show();var $clone_preview=$container.find("[data-id=clone_preview]").clone().removeAttr("data-id");$container.find("[data-id=clone_preview]").remove();var $blank_slate=$container.find(".field_blank_slate");$blank_slate.find("label").hover(function(){$(this).addClass("ui-state-hover")},function(){$(this).removeClass("ui-state-hover")});var col_size=Math.round($preview_container.outerWidth()/4);$preview_container.width($preview_container.outerWidth()-$preview_container.width());$(document).ready(function(){$currentTab.find('button.ui-priority-primary[type="submit"]').unbind().bind("click",function(){$container.closest("form").submit()})});$container.closest("form").submit(function(e){var layout=extractLayout();console.log("layout",layout);$layout.val(layout);var ajaxData={form_layout:layout};var inputs={};var fieldPrefix="field[";var idRegex=/[^\[]+\[([0-9]+)\]\[([^\]]+)\]/;$(this).find(":input").each(function(){var $this=$(this);if(!$this.attr("name")){return}if($this.attr("name").indexOf(fieldPrefix)!=0){if($this.not('[type="checkbox"]').length||$this.is(":checked")){ajaxData[$this.attr("name")]=$this.val()}return}var fieldInfos=$this.attr("name").match(idRegex);if(!fieldInfos.length||fieldInfos.length<3){return}var id=parseInt(fieldInfos[1]);var fieldName=fieldInfos[2];var value=$this.val();if($this.is(":checkbox")){value=+$this.is(":checked")}if(!id||!fieldName){return}if(!inputs[id]){inputs[id]={}}inputs[id][fieldName]=value});ajaxData["_csrf"]=$(this).find('input[name="_csrf"]:first').val();ajaxData["fields"]=JSON.stringify(inputs);console.log(ajaxData);var action=$(this).attr("action");$container.nosAjax({data:ajaxData,type:"post",url:action,dataType:"json"});return false});$container.on("click","[data-id=add]",function onAdd(event){event.preventDefault();event.stopPropagation();var params_button=$(this).data("params");$blank_slate.data("params",params_button);var pageBreakCount=getPageBreakCount();if(params_button.type=="page_break"){var field_id="page-break-"+(pageBreakCount+1);var $field=$("<div />").addClass("field_enclosure page_break").attr("data-field-id",field_id).data("field-id",field_id);$fields_container.append($field);$field.nosFormUI();var $preview=createFieldPreviewElement(field_id,params_button.where||"bottom");$preview.addClass("page_break ui-widget-header");applyPreviewLayout("page_break=4")}else{$(this).closest(".button-container")[params_button.where==="top"?"append":"prepend"]($blank_slate);$blank_slate.show();setLayoutPadding()}});$("html, body").on("click",function(){$blank_slate.hide()});$blank_slate.on("click",function(event){event.stopPropagation()});$blank_slate.on("click","label",function(event){event.preventDefault();createLayoutFields($(this).data("layout-name"))});$preview_container.on("click","td.preview",function onClickPreview(e){e.preventDefault();var $preview=$(this);var $field=getPreviewFieldElement($preview);if(!$field){return}setSelectedField($field);showField($field);getFieldProperty($field,"field_label").focus()});$preview_container.on("click","[data-id=copy]",function onClickCopy(e){e.preventDefault();e.stopPropagation()});$fields_container.on("click","[data-id=delete]",function on_delete(e){e.preventDefault();e.stopPropagation();if(confirm($.nosCleanupTranslation(options.textDelete))){var $field=getSelectedField();if($field){deleteField($field)}}});$fields_container.on("change",'select[name$="[field_driver]"]',function on_type_change(e){var $field=$(this).closest(".field_enclosure");var field_id=getFieldId($field);var fieldData=getFieldData($field);freezeField($field);$.ajax({url:"admin/noviusos_form/form/render_field/"+field_id,type:"POST",dataType:"json",data:{fieldData:JSON.stringify(fieldData)}}).done(function(json){if(json.meta){var $newField=$(json.meta);$field.replaceWith($newField);$field=$newField;$field.nosFormUI()}refreshFieldPreviewLabel($field);if(typeof json.preview!=="undefined"){setFieldPreviewContent($field,json.preview)}else{refreshFieldPreviewContent($field)}$field.find(".wijmo-wijaccordion-content").each(function(){var $accordion_content=$(this);if($accordion_content.find(":input").filter(function(){return $(this).closest("p").css("display")!="none"}).length==0){$accordion_content.prev().hide()}else{$accordion_content.prev().show()}});$field.find('[name$="[field_label]"]').trigger("change");$field.find('[name$="[field_style]"]').trigger("change")}).always(function(){console.log("unfreeze");unfreezeField($field)})});$fields_container.on("change",'select[name$="[field_style]"]',function on_style_change(e){var style=$(this).val();var $field=$(this).closest(".field_enclosure");var $message=$field.find('[name$="[field_message]"]');var $new=$(style=="p"?'<textarea rows="4"></textarea>':'<input type="text" />');$new.attr({name:$message.attr("name"),id:$message.attr("id")});$new.val($message.val());$new.insertAfter($message);$message.remove();$new.parent().nosFormUI();$new.trigger("change")});$fields_container.on("change keyup",'input[name$="[field_label]"]',function(){refreshFieldPreviewLabel($(this).closest(".field_enclosure"))});$fields_container.on("change",'input[name$="[field_mandatory]"]',function(){refreshFieldPreviewLabel($(this).closest(".field_enclosure"))});$fields_container.on("change keyup",'textarea[name$="[field_choices]"],'+'[name$="[field_message]"],'+'[name$="[field_default_value]"],'+'input[name$="[field_width]"],'+'input[name$="[field_height]"],'+'textarea[name$="[field_details]"]',function(){refreshFieldPreviewContent($(this).closest(".field_enclosure"))});$fields_container.on("refreshPreview",".field_enclosure",function(){var $field=$(this);refreshFieldPreviewContent($field);refreshFieldPreviewLabel($field)});$fields_container.children(".field_enclosure").hide();hideFieldActions();applyPreviewLayout($layout.val());setTimeout(function(){refreshPreviewHeight()},100);$fields_container.children(".field_enclosure").each(function(){refreshFieldPreviewLabel($(this))});if(is_new){createLayoutFields("default")}var $form_captcha=$container.find("[name=form_captcha]"),$form_submit_label=$container.find("[name=form_submit_label]"),$form_submit_email=$container.find("[name=form_submit_email]");$form_captcha.on("change",function(){$submit_informations.find(".form_captcha")[$(this).is(":checked")?"show":"hide"]()}).trigger("change");$form_submit_label.on("change keyup",function(){$submit_informations.find("input:last").val($(this).val())}).trigger("change");$form_submit_email.on("change keyup",function(){var mail=$.trim($(this).val());$submit_informations.find(".form_submit_email").find("span:first").html(mail.replace("\n",", ","g")).end().find("span:last")[mail?"hide":"show"]()}).trigger("change");$submit_informations.on("click",function(){var $accordion=$form_submit_label.closest(".accordion");resetSelectedField();showField($accordion);hideField();setLayoutPadding($submit_informations);$submit_informations.addClass("ui-state-active");$container.find(".preview_arrow").show()});function extractLayout(){var layout="";$container.find("tr.preview_row").each(function(i){var $preview=$(this).find("td.preview");if($preview.length>0&&layout!=""){layout+="\n"}$preview.each(function(index){var $preview=$(this);var $field=getPreviewFieldElement($preview);if($field){if(index>0){layout+=","}var field_id=$preview.is(".page_break")?"page_break":getFieldId($field);layout+=field_id+"="+getCellColspan($preview)}})});return layout}function getPageBreakCount(){return $container.find("tr.preview_row.page_break").length}function createLayoutFields(layoutName){var where=($blank_slate.data("params")||{}).where||"bottom";var nos_fixed_content=$container.closest(".nos-fixed-content").get(0);var old_scroll_top=nos_fixed_content.scrollTop;$.ajax({url:"admin/noviusos_form/form/render_layout/"+layoutName,dataType:"json",success:function(json){$blank_slate.hide();if(json.fields&&json.layout){var $fields=$(json.fields.join(""));if(where=="top"){$fields=$($fields.get().reverse())}$fields_container.append($fields);$fields=$fields.not("script");$fields.nosFormUI();var $previews=$();$fields.each(function(index){var $field=$(this);initField($field,where);if(json.previews&&json.previews[index]){setFieldPreviewContent($field,json.previews[index])}else{refreshFieldPreviewContent($field)}refreshFieldPreviewLabel($field);$previews=$previews.add(getFieldPreviewElement($field))});applyPreviewLayout(json.layout);nos_fixed_content.scrollTop=old_scroll_top;$previews.addClass("ui-state-hover");setTimeout(function(){$previews.removeClass("ui-state-hover")},500)}}})}function setLayoutPadding($target){$target=$target||$preview_container.find(".preview.ui-state-active");if($target.length==0){$target=$submit_informations.not(":not(.ui-state-active)")}if($target.length>0){var diff=$target.is(".submit_informations")?14:-40;var pos=$target.position();$fields_container.css({paddingTop:Math.max(0,pos.top+diff)+"px"})}}function showFieldActions($field){var $element=$fields_container.find(".show_hide").show();if($field&&$field.is(".page_break")){$element.addClass("page_break")}else{$element.removeClass("page_break")}}function hideFieldActions(){$fields_container.find(".show_hide").hide().removeClass("page_break")}function initField($field,where){var $driver=getFieldProperty($field,"field_driver");if($driver.length==0||!$driver.val()){return}var field_id=getFieldId($field);if(field_id){createFieldPreviewElement(field_id,where)}$field.hide()}function getFieldId($field){return $field.data("field-id")||getFieldProperty($field,"field_id").val()}function createFieldPreviewElement(field_id,where){var $clone=$clone_preview.clone();var $preview=$clone.find("td.preview");setCellColspan($preview,4);$preview.data("field-id",field_id);$preview.attr("data-field-id",field_id);$preview.find("button.notransform").removeClass("notransform");$preview.nosFormUI().show().nosOnShow();switch(where){case"top":$preview_container.prepend($preview.parent());break;case"bottom":default:$preview_container.append($preview.parent());break}return $preview}function getFieldPreviewElement($field){var field_id=getFieldId($field);return getFieldPreviewElementById(field_id)}function getFieldPreviewElementById(field_id){var $preview=$preview_container.find('.preview[data-field-id="'+field_id+'"]');return $preview.length?$preview:false}function getPreviewFieldElement($preview){var field_id=$preview.data("field-id");var $field=$fields_container.find('.field_enclosure[data-field-id="'+field_id+'"]');return $field.length?$field:false}function getFieldData($field){var data=$field.find(":input").serializeArray();for(var i=0;i<data.length;i++){data[i].name=data[i].name.replace(/field\[[0-9]*\]\[([^\]]+)\]/,"$1")}return data}function getFieldProperty($context,field_name){return $context.find('[name$="['+field_name+']"]')}function showField($field){showFieldActions($field);if($field.is(".field_enclosure")){$field.show();$field.nosOnShow()}$field.siblings(".field_enclosure").hide();setLayoutPadding();var $submit_label=getFieldProperty($field,"field_submit_label");if($submit_label.length==0){$submit_informations.removeClass("ui-state-active")}}function hideField($field){hideFieldActions();if($field){$field.hide()}}function deleteField($field){var $preview=getFieldPreviewElement($field);$field.remove();hideFieldActions();if($preview){$preview.addClass("ui-state-error").hide(500,function(){$preview.remove();initPreviewLayout()})}}function freezeField($field){$field.addClass("frozen");getFieldPreviewElement($field).addClass("frozen")}function unfreezeField($field){$field.removeClass("frozen");getFieldPreviewElement($field).removeClass("frozen")}function setFieldPreviewContent($field,content){var $preview=getFieldPreviewElement($field);var details=getFieldProperty($field,"field_details").val();if(details&&details.length>0){content+='<div class="details">'+$("<div/>").text(details).html()+"</div>"}$preview.find("div.preview_content").html(content);$preview.find("input, select").attr("readonly",true).on("click",function(event){var $selectedField=getSelectedField();if(!$selectedField||$selectedField.data("field-id")===$field.data("field-id")){event.preventDefault();event.stopPropagation()}});refreshPreviewHeight($preview.closest("tr"))}function getSelectedField(){var $preview=$preview_container.find(".preview.ui-state-active");return getPreviewFieldElement($preview)}function resetSelectedField(){var $preview=$preview_container.find(".ui-widget-content.ui-state-active");if($preview.length>0){$preview.removeClass("ui-state-active");hideField(getPreviewFieldElement($preview))}}function setSelectedField($field){var $preview=getFieldPreviewElement($field);if($preview){$preview_container.find("td.preview.ui-state-active").removeClass("ui-state-active");$preview.addClass("ui-state-active")}}function refreshFieldPreviewLabel($field){var $preview=getFieldPreviewElement($field);if(!$preview){return}var $label=$preview.find("label.preview_label");var field_driver=getFieldProperty($field,"field_driver").val();if(!isFieldInDriverMetaLayout("field_label",field_driver)){$label.hide()}else{$label.text(getFieldPreviewLabel($field));$label.show()}}function getFieldPreviewLabel($field){var label=getFieldProperty($field,"field_label").val();if(getFieldProperty($field,"field_mandatory").is(":checked")){label+="*"}return label}function refreshFieldPreviewContent($field){var field_id=getFieldId($field);var fieldData=getFieldData($field);throttle.request(function(done){$.ajax({url:"admin/noviusos_form/form/render_field_preview/"+field_id,type:"POST",dataType:"json",data:{fieldData:JSON.stringify(fieldData)}}).done(function(json){if(typeof json.preview!=="undefined"){setFieldPreviewContent($field,json.preview)}}).always(function(){done()})})}function refreshPreviewHeight($tr){($tr||$preview_container.find("tr")).css("height","").each(function sameHeight(){var $resizable=$(this).find("div.resizable").css("height","");$resizable.css("height",$(this).height())})}function getDriverConfig(driverClass,path,defaultValue){var config=options.driversConfig[driverClass]||{};if(path){return _get(config.config,path,defaultValue)}else{return config.config}}function getDriverName(driverClass){var config=options.driversConfig[driverClass]||{};return config.name}function isFieldInDriverMetaLayout(fieldName,field_driver){var driverConfig=getDriverConfig(field_driver);if(driverConfig){var layout=_get(driverConfig,"admin.layout");if(typeof layout==="object"){for(var name in layout){if(layout.hasOwnProperty(name)){if(typeof layout[name].fields==="object"&&$.inArray(fieldName,layout[name].fields)!==-1){return true}}}}}return false}function resizeToBest($tr,priority){if($tr.find("td:not(.padding)").length==0){return}$tr.find("td.padding").remove();var $cells=$tr.find("td.preview:visible");var cell_sizes=[];var total_size=0;var $widest=[];var max_cell_size=5-$cells.length;$cells.each(function(){var $cell=$(this);var $item=$cell.find(".resizable");if($item.length==0){$item=$cell}var cell_size=Math.round($item.outerWidth()/col_size);cell_size=Math.max(1,Math.min(max_cell_size,cell_size));cell_size=parseInt($item.attr("colspan"))||cell_size;cell_sizes.push(cell_size);total_size+=cell_size;$cell.data("colspan",cell_size);if($widest.length==0||cell_size>$widest.data("colspan")){$widest=$cell}});if(total_size>4){if(priority===undefined||priority==null){priority=$widest.get(0)}else{}var total_shrink_needed=total_size-4;var $shrink_me=$cells.filter(function(){return $(this).data("colspan")>1&&this!=priority});$shrink_me.closest("td.preview").each(function(){var $cell=$(this);var size=$cell.data("colspan");var shrink_by=1;while(size-shrink_by>1&&total_shrink_needed-shrink_by>0){shrink_by++}total_shrink_needed-=shrink_by;$cell.data("colspan",size-shrink_by)});if(total_shrink_needed>0){$(priority).data("colspan",$(priority).data("colspan")-total_shrink_needed)}}$tr.find("td.preview").each(function(){setCellColspan($(this),$(this).data("colspan"));$(this).removeData("colspan")});if(total_size<4){var $padding=$('<td class="padding">&nbsp;</td>');setCellColspan($padding,4-total_size);$tr.append($padding)}else{}}function setCellColspan($td,colspan){$td.attr("colspan",colspan).children().css("width","auto")}function getCellColspan($td){return Math.round($td.width()/col_size)}function saveCellWidth($tr){$tr.find("td.preview:visible").each(function(){var $this=$(this);$this.data("saved_colspan",getCellColspan($this))})}function restoreCellWidth($tr){$tr.find("td.preview:visible").each(function(){var $this=$(this);var saved_colspan=$this.data("saved_colspan");if(saved_colspan){setCellColspan($this,saved_colspan)}})}function initSortable(){try{$sortable.destroy()}catch(e){}$preview_container.find("td.padding").remove();$preview_container.find("td.sortable_placeholder").remove();$preview_container.find("tr").addClass("preview_row").filter(function(){return $(this).children().not(".placeholder").length==0}).remove();$preview_container.find("td.page_break").each(function(){var $td=$(this);setCellColspan($td,4);$td.closest("tr").addClass("page_break")});$preview_container.find("tr").before('<tr class="preview_row preview_inserter"><td class="padding" colspan="4">&nbsp;</td></tr>');$preview_container.append('<tr class="preview_row preview_inserter"><td class="padding" colspan="4">&nbsp;</td></tr>');$preview_container.find("tr.preview_row").each(function(){resizeToBest($(this))});$preview_container.find("tr").removeClass("preview_row_sortable").filter(function(){return $(this).children().not(".padding").length<4}).addClass("preview_row_sortable");var field_colspan;$sortable=$preview_container.find("tr.preview_row:not(.page_break)").sortable({connectWith:id+" tr.preview_row_sortable:not(.page_break)",dropOnEmpty:true,helper:"clone",appendTo:id,items:"> td.preview",forceHelperSize:true,placeholder:"sortable_placeholder preview",tolerance:"pointer",handle:".handle",beforeStop:function(e,ui){},start:function onSortableStart(e,ui){var $tr=ui.placeholder.closest("tr");resetSelectedField();$tr.css("height",ui.item.height());ui.placeholder.addClass("ui-widget-content ui-state-active");ui.placeholder.children().css("height",$tr.css("height"));setCellColspan(ui.placeholder,getCellColspan(ui.helper))},update:function onSortableUpdate(e,ui){var $tr=ui.item.closest("tr");$tr.css("height","");$tr.children().css("height",$tr.css("height"));setCellColspan(ui.item,field_colspan);resizeToBest($tr,ui.item.get(0));initPreviewLayout()},over:function onSortableOver(e,ui){var $tr=ui.placeholder.closest("tr");ui.item.children().css("height","");ui.placeholder.hide();saveCellWidth($tr);ui.placeholder.show();ui.placeholder.children().css("height",$tr.css("height"));setCellColspan(ui.placeholder,getCellColspan(ui.helper));resizeToBest($tr,ui.placeholder.get(0));field_colspan=getCellColspan(ui.placeholder)},out:function onSortableOut(e,ui){var $tr=ui.placeholder.closest("tr");restoreCellWidth($tr)}});$preview_container.find("tr.preview_row.page_break").sortable({appendTo:id,connectWith:id+" tr.preview_row_sortable.preview_inserter",helper:"clone",dropOnEmpty:true,forceHelperSize:true,forcePlaceholderSize:true,placeholder:"sortable_placeholder preview",handle:".handle",start:function onSortableStart(e,ui){var $tr=ui.placeholder.closest("tr");resetSelectedField();$tr.css("height",ui.item.height());ui.placeholder.addClass("ui-widget-content ui-state-active");ui.placeholder.children().css("height",$tr.css("height"));setCellColspan(ui.placeholder,4)}})}function initResizable(){try{$resizable.destroy()}catch(e){}$resizable=$preview_container.find("td.preview").not(".page_break").find("div.resizable");$resizable=$resizable.resizable({ghost:true,handles:"se",autoHideType:true,helper:"helper_resize preview ui-state-active",grid:[col_size,"2000"],start:function(e,ui){resetSelectedField()},stop:function(e,ui){var $tr=ui.element.closest("tr");resizeToBest($tr,ui.element.closest("td").get(0));refreshPreviewHeight($tr)}})}function initPreviewLayout($tr){initResizable();initSortable();refreshPreviewHeight($tr)}function applyPreviewLayout(layout){$.each(layout.split("\n"),function layoutLines(){var $previous=null;if(this==""){return}$.each(this.split(","),function layoutCols(){var item=this.split("=");var field_id=item[0];var field_width=item[1];var $preview=getFieldPreviewElementById(field_id);if($preview){setCellColspan($preview,field_width);if($previous){$previous.after($preview)}$previous=$preview}})});initPreviewLayout()}function _get(obj,path,defaultValue){var value=path.split(".").reduce(function(prev,curr){return prev?prev[curr]:undefined},obj||self);return typeof value!=="undefined"?value:defaultValue}function ThrottleRequest(updateThreshold){var running,queuedRequest,lastTime;if(typeof updateThreshold!=="number"){updateThreshold=1e3}var throttle=function(request){running=true;var doneCallback=function triggerRequestEnd(){running=false;lastTime=+new Date;if(queuedRequest){queuedRequest();queuedRequest=null}};if(lastTime){var diff=+new Date-lastTime;if(diff<updateThreshold){setTimeout(function(){request(doneCallback)},updateThreshold-diff);return}}request(doneCallback)};this.request=function(request){if(running){queuedRequest=function(){throttle(request)}}else{throttle(request)}}}function serializeObject($target){var o={};$.each($target.find(":input").serializeArray(),function(){if(o[this.name]!==undefined){if(!o[this.name].push){o[this.name]=[o[this.name]]}o[this.name].push(this.value||"")}else{o[this.name]=this.value||""}});return o}}});
//# sourceMappingURL=insert_update.min.js.map